<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTAGEM ZIZA - Modo Sincronizado</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    // ===============================
    // üî• Firebase Configura√ß√£o
    // ===============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhIcEttYA_zNawM-TgBX20pJ2rFnZ4UQM",
      authDomain: "contagem-2f002.firebaseapp.com",
      databaseURL: "https://contagem-2f002-default-rtdb.firebaseio.com",
      projectId: "contagem-2f002",
      storageBucket: "contagem-2f002.firebasestorage.app",
      messagingSenderId: "606594368212",
      appId: "1:606594368212:web:c105c3f9852e59f4667141"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ===============================
    // ‚öôÔ∏è Vari√°veis Globais
    // ===============================
    let salaAtual = prompt("Digite o c√≥digo da sala (ex: SALA123):").trim().toUpperCase();
    const userId = "user_" + Date.now();

    let basePrecos = {};
    let contagemProdutos = [];
    let valoresManuais = {};
    const camposFixos = [
      "Caixa", "Saldo", "Pagamento", "Invent√°rio", "Devolu√ß√£o", "Lucro",
      ...Array.from({ length: 30 }, (_, i) => `Lucro dia ${i + 2}`),
      "Fixo"
    ];

    const salaRef = ref(db, "salas/" + salaAtual);

    // ===============================
    // üë• Registrar Usu√°rio na Sala
    // ===============================
    update(ref(db, `salas/${salaAtual}/usuarios/${userId}`), true);

    // ===============================
    // üì¶ Carregar Base de Dados Excel
    // ===============================
    document.getElementById("arquivoExcel").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const primeira = workbook.SheetNames[0];
        const planilha = XLSX.utils.sheet_to_json(workbook.Sheets[primeira]);

        const status = document.getElementById("statusMensagem");
        if (planilha.length === 0) {
          status.textContent = "‚ö†Ô∏è Planilha vazia!";
          status.className = "erro";
          return;
        }

        const colunas = Object.keys(planilha[0]);
        const nomeCodigo = colunas.find(c => c.toLowerCase().includes('c√≥digo') || c.toLowerCase().includes('code'));
        const nomePreco = colunas.find(c => c.toLowerCase().includes('pre√ßo') || c.toLowerCase().includes('price'));

        if (!nomeCodigo || !nomePreco) {
          status.textContent = "‚ö†Ô∏è Colunas c√≥digo/pre√ßo n√£o encontradas!";
          status.className = "erro";
          return;
        }

        basePrecos = {};
        planilha.forEach(row => {
          if (row[nomeCodigo] && row[nomePreco]) {
            basePrecos[String(row[nomeCodigo]).trim().toUpperCase()] = parseFloat(row[nomePreco]);
          }
        });

        status.textContent = "‚úÖ Base carregada com sucesso!";
        status.className = "sucesso";
        document.getElementById("formulario").style.display = "block";

        renderizarCamposManuais();
      };
      reader.readAsArrayBuffer(file);
    });

    // ===============================
    // ‚ûï Adicionar Produto
    // ===============================
    document.querySelector(".btn-add").addEventListener("click", () => {
      const area = document.getElementById("areaInput").value.trim().toUpperCase();
      const codigo = document.getElementById("codigoInput").value.trim().toUpperCase();
      const quantidade = parseInt(document.getElementById("quantidadeInput").value.trim());
      const preco = basePrecos[codigo];

      if (!area) return alert("Digite a √°rea.");
      if (!codigo) return alert("Digite o c√≥digo.");
      if (!quantidade || quantidade <= 0) return alert("Quantidade inv√°lida.");
      if (!preco) return alert("C√≥digo n√£o encontrado na base!");

      const valor = preco * quantidade;
      const novoProduto = { area, codigo, pares: quantidade, preco, valor };

      const produtosRef = ref(db, `salas/${salaAtual}/contagem/produtos`);
      get(produtosRef).then(snapshot => {
        const produtos = snapshot.exists() ? snapshot.val() : [];
        produtos.push(novoProduto);
        set(produtosRef, produtos);
      });

      document.getElementById("codigoInput").value = "";
      document.getElementById("quantidadeInput").value = "";
    });

    // ===============================
    // üëÅÔ∏è Atualizar em tempo real
    // ===============================
    onValue(ref(db, `salas/${salaAtual}/contagem`), snapshot => {
      const dados = snapshot.val();
      contagemProdutos = dados?.produtos || [];
      valoresManuais = dados?.valores || {};
      renderizarLista();
      renderizarCamposManuais();
      atualizarTotaisGerais();
    });

    // ===============================
    // üóëÔ∏è Editar / Remover
    // ===============================
    window.removerProduto = (index) => {
      if (!confirm("Deseja remover este produto?")) return;
      const produtos = [...contagemProdutos];
      produtos.splice(index, 1);
      set(ref(db, `salas/${salaAtual}/contagem/produtos`), produtos);
    };

    window.editarProduto = (index) => {
      const novo = prompt("Nova quantidade:", contagemProdutos[index].pares);
      if (!novo || novo <= 0) return;
      contagemProdutos[index].pares = parseInt(novo);
      contagemProdutos[index].valor = contagemProdutos[index].preco * contagemProdutos[index].pares;
      set(ref(db, `salas/${salaAtual}/contagem/produtos`), contagemProdutos);
    };

    // ===============================
    // üìã Renderizar Lista
    // ===============================
    function renderizarLista() {
      const lista = document.getElementById("listaProdutos");
      lista.innerHTML = "";

      let html = "";
      let areaAnterior = "";
      let somaFinalArea = 0;

      contagemProdutos.forEach((item, index) => {
        const novaArea = item.area !== areaAnterior;

        if (novaArea && areaAnterior !== "") {
          html += `<div style="padding:6px; text-align:right; font-weight:bold; color:#333;">
                    ‚û°Ô∏è Total da √Årea ${areaAnterior}: ${somaFinalArea}
                  </div>`;
        }

        if (novaArea) {
          html += `<div style="margin-top:20px; background:#f8f9fa; padding:6px; border-left:4px solid #007bff;">
                    <strong>${item.area}</strong>
                  </div>`;
          areaAnterior = item.area;
          somaFinalArea = 0;
        }

        html += `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:5px;">
                  <div>${item.codigo} ‚Äî ${item.pares} √ó ${item.preco} = <b>${item.valor}</b></div>
                  <div>
                    <button onclick="editarProduto(${index})">‚úèÔ∏è</button>
                    <button onclick="removerProduto(${index})">üóëÔ∏è</button>
                  </div>
                </div>`;

        somaFinalArea += item.pares + item.preco;
      });

      lista.innerHTML = html;
    }

    // ===============================
    // üí∞ Campos Manuais
    // ===============================
    function renderizarCamposManuais() {
      const container = document.getElementById("inputsManuais");
      container.innerHTML = "";
      camposFixos.forEach(campo => {
        const valor = valoresManuais[campo] || "";
        const div = document.createElement("div");
        div.innerHTML = `<label>${campo}</label>
                         <input type="number" data-nome="${campo}" value="${valor}" oninput="salvarValorManual('${campo}', this.value)">`;
        container.appendChild(div);
      });
      atualizarTotaisGerais();
    }

    window.salvarValorManual = (campo, valor) => {
      valoresManuais[campo] = parseFloat(valor) || 0;
      update(ref(db, `salas/${salaAtual}/contagem/valores`), valoresManuais);
      atualizarTotaisGerais();
    };

    function atualizarTotaisGerais() {
      let total = contagemProdutos.reduce((soma, item) => soma + item.valor, 0);
      let fixo = valoresManuais["Fixo"] || 0;

      for (const [chave, val] of Object.entries(valoresManuais)) {
        if (chave.toLowerCase().includes("lucro")) total -= Math.abs(val);
        else if (chave !== "Fixo") total += val;
      }

      document.getElementById("valorTotal").textContent = total.toFixed(2);
      document.getElementById("valorConclusao").textContent = (total - fixo).toFixed(2);
    }
  </script>

  <style>
    body { font-family: 'Segoe UI'; background-color: #f3f4f6; padding: 15px; }
    .container { max-width: 600px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    input, button { font-size:1em; margin:5px 0; padding:10px; border-radius:6px; border:1px solid #ccc; width:100%; }
    button { cursor:pointer; }
    .btn-add { background:#28a745; color:white; border:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì¶ CONTAGEM ZIZA (Sincronizado)</h2>

    <label>Carregar base (Excel)</label>
    <input type="file" id="arquivoExcel" accept=".xlsx" />
    <div id="statusMensagem"></div>

    <div id="formulario" style="display:none;">
      <input type="text" id="areaInput" placeholder="√Årea (Ex: Prateleira 1)" />
      <input type="text" id="codigoInput" placeholder="C√≥digo do produto" />
      <input type="number" id="quantidadeInput" placeholder="Quantidade (pares)" />
      <button class="btn-add">Adicionar</button>

      <div id="listaProdutos"></div>

      <h3>üìä Valores Manuais</h3>
      <div id="inputsManuais"></div>

      <div style="margin-top:10px; text-align:center; font-weight:bold;">
        TOTAL: <span id="valorTotal">0</span> | CONCLUS√ÉO: <span id="valorConclusao">0</span>
      </div>
    </div>
  </div>
</body>
</html>