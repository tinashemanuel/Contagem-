<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CONTAGEM ZIZA - Modo Sincronizado</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">

    // üî• Firebase Modular
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, push, update, get, set, runTransaction
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // ‚öôÔ∏è Configura√ß√£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZW_e5gBFtqvE53nfhIFZiEzxvMWmDAMQ",
      authDomain: "minha-flor.firebaseapp.com",
      databaseURL: "https://minha-flor-default-rtdb.firebaseio.com",
      projectId: "minha-flor",
      storageBucket: "minha-flor.firebasestorage.app",
      messagingSenderId: "259987990756",
      appId: "1:259987990756:web:842744a1f045c9c8c7a4f1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // üì¶ Vari√°veis
    let codigoSala = "";
    let usuarioId = "user_" + Math.random().toString(36).substring(2, 8);
    let contagemProdutos = [];
    let ordemAreas = [];
    let basePrecos = {};
    let valoresManuais = { Caixa: 0, Saldo: 0, Lucro: 0 };

    // üîπ Entrar ou criar sala
    async function entrarSala() {
      codigoSala = document.getElementById("codigoSala").value.trim().toUpperCase();
      if (!codigoSala) return alert("Digite o c√≥digo da sala.");

      const salaRef = ref(db, `salas/${codigoSala}`);
      const snapshot = await get(salaRef);

      if (!snapshot.exists()) {
        // ‚úÖ Criar sala com estrutura inicial
        await set(salaRef, {
          usuarios: { [usuarioId]: true },
          contagem: {
            produtos: {},
            ordemAreas: [],
            valores: valoresManuais
          }
        });
      } else {
        // ‚úÖ Adiciona usu√°rio existente
        await update(ref(db, `salas/${codigoSala}/usuarios`), { [usuarioId]: true });
      }

      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "block";

      escutarAlteracoes();
    }

    // üëÇ Sincronizar dados em tempo real
    function escutarAlteracoes() {
      const contagemRef = ref(db, `salas/${codigoSala}/contagem`);
      onValue(contagemRef, (snap) => {
        const data = snap.val();
        if (!data) return;
        contagemProdutos = Object.values(data.produtos || {});
        ordemAreas = data.ordemAreas || [];
        valoresManuais = data.valores || { Caixa: 0, Saldo: 0, Lucro: 0 };
        renderizarLista();
        atualizarTotaisGerais();
      });
    }

    // ‚ûï Adicionar produto
    async function adicionarProduto() {
      const area = document.getElementById("areaInput").value.trim().toUpperCase();
      const codigo = document.getElementById("codigoInput").value.trim().toUpperCase();
      const quantidade = parseInt(document.getElementById("quantidadeInput").value.trim());

      if (!area || !codigo || !quantidade || quantidade <= 0) {
        return alert("‚ö†Ô∏è Preencha todos os campos corretamente.");
      }

      let preco = basePrecos[codigo];
      if (!preco) {
        const precoManualStr = prompt(`Digite o pre√ßo para "${codigo}":`);
        const precoManual = parseFloat(precoManualStr.replace(",", "."));
        if (isNaN(precoManual) || precoManual <= 0) return alert("‚ö†Ô∏è Pre√ßo inv√°lido.");
        basePrecos[codigo] = precoManual;
        preco = precoManual;
      }

      const valor = preco * quantidade;
      const produto = { area, codigo, pares: quantidade, preco, valor, autor: usuarioId };

      // üîπ Adicionar produto no Firebase
      const produtosRef = ref(db, `salas/${codigoSala}/contagem/produtos`);
      await push(produtosRef, produto);

      // üîπ Atualizar ordem de √°reas de forma segura
      await runTransaction(ref(db, `salas/${codigoSala}/contagem/ordemAreas`), current => {
        if (!current) current = [];
        if (!current.includes(area)) current.push(area);
        return current;
      });

      // Limpar campos
      document.getElementById("codigoInput").value = "";
      document.getElementById("quantidadeInput").value = "";
      document.getElementById("codigoInput").focus();
    }

    // üßÆ Atualizar totais
    function atualizarTotaisGerais() {
      const total = contagemProdutos.reduce((sum, p) => sum + p.valor, 0);
      document.getElementById("totalGeral").textContent = "Total: " + total.toLocaleString("pt-MZ") + " MT";
    }

    // üìã Renderizar lista
    function renderizarLista() {
      const div = document.getElementById("listaProdutos");
      div.innerHTML = "";

      const agrupado = {};
      contagemProdutos.forEach(p => {
        if (!agrupado[p.area]) agrupado[p.area] = [];
        agrupado[p.area].push(p);
      });

      for (const area of ordemAreas) {
        const produtos = agrupado[area] || [];
        const totalArea = produtos.reduce((sum, p) => sum + p.valor, 0);
        const bloco = document.createElement("div");
        bloco.className = "blocoArea";
        bloco.innerHTML = `
          <h3>${area}</h3>
          <table>
            <tr><th>C√≥digo</th><th>Pares</th><th>Pre√ßo</th><th>Valor</th></tr>
            ${produtos.map(p => `
              <tr>
                <td>${p.codigo}</td>
                <td>${p.pares}</td>
                <td>${p.preco}</td>
                <td>${p.valor}</td>
              </tr>
            `).join("")}
          </table>
          <div class="totalArea">Total: ${totalArea.toLocaleString("pt-MZ")} MT</div>
        `;
        div.appendChild(bloco);
      }
    }

    // üì§ Exportar Excel
    function exportarExcel() {
      const wb = XLSX.utils.book_new();
      const dados = [["√Årea", "C√≥digo", "Pares", "Pre√ßo", "Valor"]];
      contagemProdutos.forEach(p => dados.push([p.area, p.codigo, p.pares, p.preco, p.valor]));
      const ws = XLSX.utils.aoa_to_sheet(dados);
      XLSX.utils.book_append_sheet(wb, ws, "Contagem");
      XLSX.writeFile(wb, `Contagem_${codigoSala}.xlsx`);
    }

    // üåê Fun√ß√µes globais
    window.entrarSala = entrarSala;
    window.adicionarProduto = adicionarProduto;
    window.exportarExcel = exportarExcel;

  </script>

  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f2f4f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    #app { display: none; }
    input, button { padding: 8px; margin: 5px; font-size: 15px; border-radius: 8px; }
    button { background: #007bff; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    .blocoArea { background: white; padding: 10px; margin: 10px 0; border-radius: 10px; box-shadow: 0 0 4px #ccc; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #ddd; padding: 6px; text-align: center; }
    .totalArea { text-align: right; font-weight: bold; margin-top: 5px; background: #f9f9f9; padding: 5px; border-radius: 5px; }
    #totalGeral { text-align: center; font-size: 20px; margin-top: 20px; font-weight: bold; color: #2b7a2b; }
  </style>
</head>
<body>
  <h1>üìä CONTAGEM ZIZA - Modo Sincronizado</h1>

  <div id="login" style="text-align:center;">
    <input id="codigoSala" placeholder="C√≥digo da Sala">
    <button onclick="entrarSala()">Entrar</button>
  </div>

  <div id="app">
    <div style="text-align:center;">
      <input id="areaInput" placeholder="√Årea">
      <input id="codigoInput" placeholder="C√≥digo">
      <input id="quantidadeInput" type="number" placeholder="Pares">
      <button onclick="adicionarProduto()">Adicionar</button>
      <button onclick="exportarExcel()">Exportar Excel</button>
    </div>
    <div id="listaProdutos"></div>
    <div id="totalGeral">Total: 0 MT</div>
  </div>
</body>
</html>