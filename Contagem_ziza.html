<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTAGEM ZIZA - Modo Sincronizado</title>

  <!-- Biblioteca XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { 
      getDatabase, ref, push, update, remove, onValue, get 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // --- Configura칞칚o Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAhIcEttYA_zNawM-TgBX20pJ2rFnZ4UQM",
      authDomain: "contagem-2f002.firebaseapp.com",
      databaseURL: "https://contagem-2f002-default-rtdb.firebaseio.com",
      projectId: "contagem-2f002",
      storageBucket: "contagem-2f002.firebasestorage.app",
      messagingSenderId: "606594368212",
      appId: "1:606594368212:web:c105c3f9852e59f4667141"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const salaId = "SALA123";

    const produtosRef = ref(db, `salas/${salaId}/contagem/produtos`);
    const valoresRef = ref(db, `salas/${salaId}/contagem/valores`);
    const ordemAreasRef = ref(db, `salas/${salaId}/contagem/ordemAreas`);

    // --- Elementos DOM ---
    const areaInput = document.getElementById("area");
    const codigoInput = document.getElementById("codigo");
    const paresInput = document.getElementById("pares");
    const precoInput = document.getElementById("preco");
    const adicionarBtn = document.getElementById("adicionar");
    const tabela = document.getElementById("tabela");
    const valoresDiv = document.getElementById("valores");
    const exportarBtn = document.getElementById("exportarExcel");

    // --- Adicionar produto ---
    adicionarBtn.addEventListener("click", async () => {
      const area = areaInput.value.trim();
      const codigo = codigoInput.value.trim();
      const pares = parseInt(paresInput.value);
      const preco = parseFloat(precoInput.value);

      if (!area || !codigo || isNaN(pares) || isNaN(preco)) {
        alert("丘멆잺 Preencha todos os campos corretamente!");
        return;
      }

      const valor = pares * preco;
      const novoProduto = { area, codigo, pares, preco, valor };

      // 游녤 push() adiciona um item  lista sem apagar os anteriores
      await push(produtosRef, novoProduto);

      // Atualiza lista de 치reas
      const snapAreas = await get(ordemAreasRef);
      const areas = snapAreas.exists() ? snapAreas.val() : [];
      if (!areas.includes(area)) {
        areas.push(area);
        await update(ordemAreasRef, areas);
      }

      // Limpa campos
      areaInput.value = "";
      codigoInput.value = "";
      paresInput.value = "";
      precoInput.value = "";
    });

    // --- Atualiza칞칚o em tempo real ---
    onValue(produtosRef, (snapshot) => {
      tabela.innerHTML = "";
      const produtos = snapshot.val();
      if (produtos) {
        Object.values(produtos).forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.area}</td>
            <td>${p.codigo}</td>
            <td>${p.pares}</td>
            <td>${p.preco}</td>
            <td>${p.valor}</td>
          `;
          tabela.appendChild(tr);
        });
      }
    });

    // --- Sincroniza칞칚o dos valores manuais ---
    onValue(valoresRef, (snapshot) => {
      valoresDiv.innerHTML = "";
      const valores = snapshot.val();
      if (valores) {
        for (const [chave, valor] of Object.entries(valores)) {
          const p = document.createElement("p");
          p.textContent = `${chave}: ${valor}`;
          valoresDiv.appendChild(p);
        }
      }
    });

    // --- Atualizar valores manuais ---
    window.salvarValor = async (campo) => {
      const valor = parseFloat(document.getElementById(campo).value) || 0;
      await update(valoresRef, { [campo]: valor });
    };

    // --- Exportar para Excel ---
    exportarBtn.addEventListener("click", async () => {
      const snapProdutos = await get(produtosRef);
      const snapValores = await get(valoresRef);
      const produtos = snapProdutos.exists() ? snapProdutos.val() : {};
      const valores = snapValores.exists() ? snapValores.val() : {};

      const ws_data = [["츼rea", "C칩digo", "Pares", "Pre칞o", "Valor"]];
      let total = 0;

      Object.values(produtos).forEach((p) => {
        ws_data.push([p.area, p.codigo, p.pares, p.preco, p.valor]);
        total += p.valor;
      });

      ws_data.push([]);
      ws_data.push(["", "", "", "Total Produtos", total]);
      ws_data.push([]);
      ws_data.push(["Categoria", "Valor"]);

      for (const [chave, valor] of Object.entries(valores)) {
        ws_data.push([chave, valor]);
      }

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Contagem");
      XLSX.writeFile(wb, `Contagem_${salaId}.xlsx`);
    });
  </script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f7f9fb;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 { color: #2a6ebb; }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background-color: #2a6ebb;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #1c4f8a; }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th { background-color: #e9f0fb; }
    .valores {
      margin-top: 20px;
      background: #eef5ff;
      border-radius: 10px;
      padding: 10px;
      display: inline-block;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>CONTAGEM ZIZA - Modo Sincronizado</h1>

  <div>
    <input type="text" id="area" placeholder="츼rea (ex: PRATELEIRA_1)">
    <input type="text" id="codigo" placeholder="C칩digo do Produto">
    <input type="number" id="pares" placeholder="Pares">
    <input type="number" id="preco" placeholder="Pre칞o">
    <button id="adicionar">Adicionar Produto</button>
    <button id="exportarExcel">游늵 Exportar Excel</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>츼rea</th>
        <th>C칩digo</th>
        <th>Pares</th>
        <th>Pre칞o</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>

  <div class="valores" id="valores">
    <h3>Valores Manuais</h3>
    <p>Caixa: <input id="Caixa" type="number" onblur="salvarValor('Caixa')"></p>
    <p>Saldo: <input id="Saldo" type="number" onblur="salvarValor('Saldo')"></p>
    <p>Pagamento: <input id="Pagamento" type="number" onblur="salvarValor('Pagamento')"></p>
    <p>Inventario: <input id="Inventario" type="number" onblur="salvarValor('Inventario')"></p>
    <p>Lucro: <input id="Lucro" type="number" onblur="salvarValor('Lucro')"></p>
  </div>
</body>
</html>