<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTAGEM ZIZA - Modo Sincronizado</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color:#f1f3f5; margin:0; padding:15px; }
    .container { max-width:600px; margin:auto; background:#fff; border-radius:10px; padding:20px; box-shadow:0 0 15px rgba(0,0,0,0.1); }
    h2,h3 { text-align:center; color:#333; font-size:1.5em; }
    .input { width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc; font-size:1em; }
    .btn { width:100%; padding:12px; margin-top:10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1em; }
    .btn-add { background-color:#28a745; color:white; }
    .btn-export { background-color:#007bff; color:white; }
    #listaProdutos > div { margin-top:10px; }
    #valoresManuais { margin-top:30px; border-top:2px solid #ddd; padding-top:20px; }
    #inputsManuais { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    #inputsManuais label { font-weight:600; color:#444; font-size:0.9em; margin-bottom:4px; display:block; }
    #inputsManuais input[type="number"] { width:100%; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:14px; }
    #totaisContainer { margin-top:15px; font-weight:bold; font-size:1em; text-align:center; }
    @media (max-width:500px) { #inputsManuais { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì¶ CONTAGEM ZIZA - Modo Sincronizado</h2>

    <label>1¬∫ Passo: Carregar base de dados (Excel)</label>
    <input type="file" id="arquivoExcel" accept=".xlsx" class="input" />

    <div id="statusMensagem" style="text-align:center; margin-top:10px;"></div>

    <div id="formulario" style="display:none; margin-top:20px;">
      <label>2¬∫ Passo: Inserir Contagem</label>
      <input type="text" id="areaInput" placeholder="√Årea (Ex: Prateleira 1)" class="input" />
      <input type="text" id="codigoInput" placeholder="C√≥digo do produto" class="input" />
      <input type="number" id="quantidadeInput" placeholder="Quantidade (pares)" class="input" />
      <button id="btnAdicionar" class="btn btn-add">‚ûï Adicionar</button>
      <button id="btnExportar" class="btn btn-export">üì§ Exportar Contagem</button>

      <div id="listaProdutos" style="margin-top:20px;"></div>

      <div id="valoresManuais">
        <h3>üìä Valores Manuais</h3>
        <div id="inputsManuais"></div>
        <div id="totaisContainer">
          TOTAL: <span id="valorTotal">0</span> &nbsp;&nbsp;|&nbsp;&nbsp; CONCLUS√ÉO: <span id="valorConclusao">0</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhIcEttYA_zNawM-TgBX20pJ2rFnZ4UQM",
      authDomain: "contagem-2f002.firebaseapp.com",
      projectId: "contagem-2f002",
      storageBucket: "contagem-2f002.firebasestorage.app",
      messagingSenderId: "606594368212",
      appId: "1:606594368212:web:c105c3f9852e59f4667141",
      databaseURL: "https://contagem-2f002-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Sala
    function getCodigoSala() { return new URLSearchParams(window.location.search).get("sala"); }
    let salaCodigo = getCodigoSala();
    if(!salaCodigo){
      // Se n√£o houver sala na URL, gera aleat√≥ria
      salaCodigo = "SALA" + Math.floor(Math.random()*9000+1000);
      alert(`Sala n√£o informada. Criando sala tempor√°ria: ${salaCodigo}`);
      window.history.replaceState({}, "", `?sala=${salaCodigo}`);
    }

    const salaRef = ref(db, `salas/${salaCodigo}`);

    // Cria a sala se n√£o existir
    async function criarSalaSeNaoExistir(){
      const snapshot = await get(salaRef);
      if(!snapshot.exists()){
        await set(salaRef, {
          criadaEm: new Date().toISOString(),
          usuarios: {},
          contagem: { produtos: [], ordemAreas: [], valores: {} }
        });
        console.log("Sala criada automaticamente:", salaCodigo);
      }
    }
    await criarSalaSeNaoExistir();

    let basePrecos = {};
    let contagemProdutos = [];
    const camposFixos = ["Caixa","Saldo","Pagamento","Invent√°rio","Devolu√ß√£o","Lucro", ...Array.from({length:30}, (_,i)=>`Lucro dia ${i+2}`), "Fixo"];
    let valoresManuais = {};

    const produtosRef = ref(db, `salas/${salaCodigo}/contagem/produtos`);

    // Escuta em tempo real
    onValue(produtosRef, snapshot=>{
      const data = snapshot.exists() ? snapshot.val() : {};
      contagemProdutos = Object.keys(data).map(key => ({ id: key, ...data[key] }));
      renderizarLista();
      atualizarTotaisGerais();
    });

    // Carregar Excel
    document.getElementById("arquivoExcel").addEventListener("change", e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data,{type:"array"});
        const primeira = workbook.SheetNames[0];
        const planilha = XLSX.utils.sheet_to_json(workbook.Sheets[primeira]);

        const status = document.getElementById("statusMensagem");
        if(planilha.length===0){ status.textContent="‚ö†Ô∏è Planilha vazia"; return; }

        const colunas = Object.keys(planilha[0]);
        const nomeCodigo = colunas.find(c=>c.toLowerCase().includes('c√≥digo'));
        const nomePreco = colunas.find(c=>c.toLowerCase().includes('pre√ßo'));

        if(!nomeCodigo||!nomePreco){ status.textContent="‚ö†Ô∏è Colunas c√≥digo/pre√ßo n√£o encontradas"; return; }

        basePrecos = {};
        planilha.forEach(row=>{ 
          if(row[nomeCodigo] && row[nomePreco]) 
            basePrecos[String(row[nomeCodigo]).trim().toUpperCase()] = parseFloat(row[nomePreco]); 
        });

        if(Object.keys(basePrecos).length===0){ status.textContent="‚ö†Ô∏è Nenhum c√≥digo/pre√ßo v√°lido"; return; }

        status.textContent="‚úÖ Base carregada com sucesso";
        document.getElementById("formulario").style.display="block";
        renderizarCamposManuais();
      };
      reader.readAsArrayBuffer(file);
    });

    // Fun√ß√µes produtos
    async function adicionarProduto(){
      try {
        const area = document.getElementById("areaInput").value.trim().toUpperCase();
        const codigo = document.getElementById("codigoInput").value.trim().toUpperCase();
        const quantidade = parseInt(document.getElementById("quantidadeInput").value.trim());
        const preco = basePrecos[codigo];
        if(!area || !codigo || !quantidade || !preco){ alert("‚ö†Ô∏è Preencha todos os campos corretamente!"); return; }

        const produto = { √°rea: area, c√≥digo: codigo, pares: quantidade, pre√ßo: preco, valor: preco*quantidade };
        await push(produtosRef, produto);
        console.log("‚úÖ Produto adicionado:", produto);

        document.getElementById("codigoInput").value = "";
        document.getElementById("quantidadeInput").value = "";
        document.getElementById("codigoInput").focus();
      } catch(e) {
        console.error("Erro ao adicionar produto:", e);
        alert("‚ùå Erro ao adicionar produto. Veja console para detalhes.");
      }
    }

    async function editarProduto(index){
      const produto = contagemProdutos[index];
      const novoValor = prompt(`Editar quantidade de pares para ${produto.c√≥digo}:`, produto.pares);
      const pares = parseInt(novoValor);
      if(!pares || pares <= 0){ alert("‚ö†Ô∏è Quantidade inv√°lida."); return; }

      const produtoRefEdit = ref(db, `salas/${salaCodigo}/contagem/produtos/${produto.id}`);
      await set(produtoRefEdit, { ...produto, pares, valor: produto.pre√ßo * pares });
    }

    async function removerProduto(index){
      const produto = contagemProdutos[index];
      if(!confirm(`Deseja remover ${produto.c√≥digo}?`)) return;

      const produtoRefRemover = ref(db, `salas/${salaCodigo}/contagem/produtos/${produto.id}`);
      await set(produtoRefRemover, null);
    }

    function renderizarLista(){
      const lista = document.getElementById("listaProdutos");
      lista.innerHTML="";
      let html="", areaAnterior="", somaFinalArea=0;

      contagemProdutos.forEach((item,index)=>{
        const novaArea = item.√°rea !== areaAnterior;
        if(novaArea && areaAnterior!=="") html+=`<div style="padding:6px;text-align:right;font-weight:bold;color:#333;">‚û°Ô∏è Total da √Årea ${areaAnterior}: ${formatarValor(somaFinalArea)} (pares+pre√ßos)</div>`;
        if(novaArea){ html+=`<div style="margin-top:30px;padding:8px;background:#f8f9fa;border-left:4px solid #007bff;"><strong>√Årea:</strong> ${item.√°rea}</div>`; areaAnterior=item.√°rea; somaFinalArea=0; }
        html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #ccc;">
          <div><div><strong>${item.c√≥digo}</strong></div><div>${item.pares} pares √ó ${formatarValor(item.pre√ßo)} = <strong>${formatarValor(item.valor)}</strong></div></div>
          <div style="display:flex;gap:5px;">
            <button data-index="${index}" class="btn-editar" style="background:#ffc107;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">‚úèÔ∏è Editar</button>
            <button data-index="${index}" class="btn-remover" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:5px;">üóëÔ∏è Remover</button>
          </div>
        </div>`;
        somaFinalArea+=item.pares+item.pre√ßo;
      });

      if(areaAnterior!=="") html+=`<div style="padding:6px;text-align:right;font-weight:bold;color:#333;">‚û°Ô∏è Total da √Årea ${areaAnterior}: ${formatarValor(somaFinalArea)} (pares+pre√ßos)</div>`;
      lista.innerHTML=html;

      document.querySelectorAll(".btn-editar").forEach(btn=>btn.addEventListener("click", e=>editarProduto(e.target.dataset.index)));
      document.querySelectorAll(".btn-remover").forEach(btn=>btn.addEventListener("click", e=>removerProduto(e.target.dataset.index)));

      renderizarCamposManuais();
    }

    function renderizarCamposManuais(){
      const container=document.getElementById("inputsManuais"); container.innerHTML="";
      camposFixos.forEach(campo=>{
        const div=document.createElement("div");
        div.innerHTML=`<label>${campo}</label><input type="number" data-nome="${campo}" value="${valoresManuais[campo]||''}" style="width:100%;padding:5px;border-radius:4px;border:1px solid #ccc;" oninput="atualizarTotaisGerais()">`;
        container.appendChild(div);
      });
      atualizarTotaisGerais();
    }

    function atualizarTotaisGerais(){
      let total=contagemProdutos.reduce((soma,item)=>soma+item.valor,0);
      document.querySelectorAll('#inputsManuais input').forEach(input=>{
        const nome=input.dataset.nome;
        let valor=parseFloat(input.value)||0;
        if(nome.toLowerCase().includes('lucro')) valor=-Math.abs(valor);
        valoresManuais[nome]=valor;
        if(nome!=="Fixo") total+=valor;
      });
      const fixo=valoresManuais["Fixo"]||0;
      document.getElementById("valorTotal").textContent=formatarValor(total);
      document.getElementById("valorConclusao").textContent=formatarValor(total-fixo);
    }

    function formatarValor(num){ return Number.isInteger(num)?num.toString():num.toFixed(2); }

    function exportarParaExcel(){
      if(contagemProdutos.length===0){ alert("‚ö†Ô∏è Nenhum item para exportar."); return; }
      const agrupado={};
      contagemProdutos.forEach(item=>{ if(!agrupado[item.√°rea]) agrupado[item.√°rea]=[]; agrupado[item.√°rea].push(item); });
      const dadosFinal=[["√Årea","C√≥digo","Pares","Pre√ßo","Valor"]];
      for(const area in agrupado){ agrupado[area].forEach(item=>{ dadosFinal.push([item.√°rea,item.c√≥digo,item.pares,formatarValor(item.pre√ßo),formatarValor(item.valor)]); }); dadosFinal.push([""]); }
      dadosFinal.push([""],[""]);
      let totalProdutos=contagemProdutos.reduce((sum,item)=>sum+item.valor,0);
      let totalFinal=totalProdutos;
      camposFixos.forEach(campo=>{
        if(campo==="Fixo") return;
        let valor=parseFloat(valoresManuais[campo])||0;
        if(campo.toLowerCase().includes("lucro")) valor=-Math.abs(valor);
        totalFinal+=valor;
        dadosFinal.push(["","", "", campo.toUpperCase(), formatarValor(valor)]);
      });
      dadosFinal.push(["","", "", "TOTAL", formatarValor(totalFinal)]);
      let fixo=parseFloat(valoresManuais["Fixo"])||0;
      dadosFinal.push(["","", "", "FIXO", formatarValor(fixo)]);
      dadosFinal.push(["","", "", "CONCLUS√ÉO", formatarValor(totalFinal-fixo)]);
      const ws=XLSX.utils.aoa_to_sheet(dadosFinal);
      ws['!cols']=[{wch:12},{wch:12},{wch:10},{wch:15},{wch:12}];
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Contagem");
      XLSX.writeFile(wb,"contagem_ziza.xlsx");
    }

    // Conectar bot√µes
    document.getElementById("btnAdicionar").addEventListener("click", adicionarProduto);
    document.getElementById("btnExportar").addEventListener("click", exportarParaExcel);

  </script>
</body>
</html>