<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTAGEM ZIZA - Modo Sincronizado</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f1f3f5; margin:0; padding:15px; }
    .container { max-width:600px; margin:auto; background:#fff; border-radius:10px; padding:20px; box-shadow:0 0 15px rgba(0,0,0,0.1);}
    h2,h3 { text-align:center; color:#333; font-size:1.5em;}
    .upload-label { display:block; margin-bottom:10px; font-weight:bold; color:#555; font-size:1em; }
    .file-input { display:flex; align-items:center; justify-content:center; background:#e9ecef; padding:12px; border-radius:8px; border:2px dashed #ccc; cursor:pointer; text-align:center; color:#555; font-size:0.95em;}
    .file-input input[type="file"] { display:none; }
    #statusMensagem { margin-top:10px; font-size:0.95em; font-weight:bold; text-align:center;}
    .sucesso { color:green; } .erro { color:red; }
    .btn { width:100%; padding:12px; margin-top:10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1em; }
    .btn-add { background:#28a745; color:white; }
    .btn-export { background:#007bff; color:white; }
    #listaProdutos > div { margin-top:10px; }
    #valoresManuais { margin-top:30px; border-top:2px solid #ddd; padding-top:20px; }
    #inputsManuais { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    #inputsManuais label { font-weight:600; color:#444; margin-bottom:4px; display:block; font-size:0.9em; }
    #inputsManuais input[type="number"] { width:100%; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:14px; }
    #totaisContainer { margin-top:15px; font-weight:bold; font-size:1em; text-align:center; }
    input.input { padding:12px; border-radius:6px; border:1px solid #ccc; font-size:1em; }
    @media (max-width:500px){h2{font-size:1.2em;} .btn{padding:10px;font-size:0.95em;} .file-input{padding:10px;font-size:0.9em;} #inputsManuais{grid-template-columns:1fr;} input.input{padding:10px;font-size:0.95em;} #inputsManuais input[type="number"]{font-size:0.95em;} #totaisContainer{font-size:0.95em;}}
  </style>
</head>
<body>

<div class="container">
  <h2>üì¶ CONTAGEM ZIZA - Modo Sincronizado</h2>

  <div style="text-align:center; margin-bottom:10px;">
    <div><strong>Sala:</strong> <span id="codigoSalaDisplay">---</span></div>
    <div><strong>Usu√°rios online:</strong> <span id="totalUsuarios">0</span></div>
  </div>

  <label class="upload-label">1¬∫ Passo: Carregue a base de dados (Excel)</label>
  <label class="file-input" for="arquivoExcel">üìÅ Clique aqui para escolher o arquivo Excel (.xlsx)
    <input type="file" id="arquivoExcel" accept=".xlsx" />
  </label>
  <div id="statusMensagem"></div>

  <div id="formulario" style="display:none; margin-top:20px;">
    <label class="upload-label">2¬∫ Passo: Inserir Contagem</label>

    <input type="text" id="areaInput" placeholder="√Årea (Ex: Prateleira 1)" class="input" />
    <input type="text" id="codigoInput" placeholder="C√≥digo do produto" class="input" />
    <input type="number" id="quantidadeInput" placeholder="Quantidade (pares)" class="input" />

    <button onclick="adicionarProduto()" class="btn btn-add">‚ûï Adicionar</button>
    <button onclick="exportarParaExcel()" class="btn btn-export">üì§ Exportar Contagem</button>
    <button onclick="limparContagem()" class="btn" style="background-color:#6c757d;color:white;">üßπ Limpar Contagem</button>

    <div id="listaProdutos" style="margin-top:20px;"></div>

    <div id="valoresManuais">
      <h3>üìä Valores Manuais</h3>
      <div id="inputsManuais"></div>
      <div id="totaisContainer">
        TOTAL: <span id="valorTotal">0</span> &nbsp;&nbsp;|&nbsp;&nbsp; CONCLUS√ÉO: <span id="valorConclusao">0</span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAhIcEttYA_zNawM-TgBX20pJ2rFnZ4UQM",
  authDomain: "contagem-2f002.firebaseapp.com",
  databaseURL: "https://contagem-2f002-default-rtdb.firebaseio.com",
  projectId: "contagem-2f002",
  storageBucket: "contagem-2f002.firebasestorage.app",
  messagingSenderId: "606594368212",
  appId: "1:606594368212:web:c105c3f9852e59f4667141"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window.Firebase = { db, ref, set, update, onValue, onDisconnect, remove };

// Vari√°veis globais
let basePrecos = {};
let contagemProdutos = [];
let ordemAreas = [];
let valoresManuais = {};
const camposFixos = ["Caixa","Saldo","Pagamento","Invent√°rio","Devolu√ß√£o","Lucro", ...Array.from({length:30},(_,i)=>`Lucro dia ${i+2}`),"Fixo"];
let codigoSala = null;
let usuarioId = null;

// -------------------- Arquivo Excel --------------------
document.getElementById("arquivoExcel").addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data,{type:"array"});
    const planilha = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
    const status = document.getElementById("statusMensagem");

    if(planilha.length === 0){ status.textContent="‚ö†Ô∏è A planilha est√° vazia."; status.className="erro"; return; }

    const colunas = Object.keys(planilha[0]);
    const nomeCodigo = colunas.find(c=>c.includes('Á†Å') || c.toLowerCase().includes('c√≥digo'));
    const nomePreco = colunas.find(c=>c.includes('‰ª∑') || c.toLowerCase().includes('pre√ßo'));

    if(!nomeCodigo || !nomePreco){ status.textContent="‚ö†Ô∏è As colunas de c√≥digo ou pre√ßo n√£o foram encontradas!"; status.className="erro"; return; }

    basePrecos = {};
    planilha.forEach(row=>{
      if(row[nomeCodigo] && row[nomePreco]) basePrecos[String(row[nomeCodigo]).trim().toUpperCase()] = parseFloat(row[nomePreco]);
    });

    if(Object.keys(basePrecos).length === 0){ status.textContent="‚ö†Ô∏è Nenhum c√≥digo/pre√ßo v√°lido encontrado!"; status.className="erro"; }
    else { status.textContent="‚úÖ Base carregada com sucesso!"; status.className="sucesso"; document.getElementById("formulario").style.display="block"; localStorage.setItem("basePrecosZiza",JSON.stringify(basePrecos)); renderizarCamposManuais(); }
  };
  reader.readAsArrayBuffer(file);
});

const baseSalva = localStorage.getItem("basePrecosZiza");
if(baseSalva){ try{ basePrecos=JSON.parse(baseSalva); document.getElementById("formulario").style.display="block"; document.getElementById("statusMensagem").textContent="‚úÖ Base carregada do armazenamento local!"; document.getElementById("statusMensagem").className="sucesso"; renderizarCamposManuais(); }catch(e){console.warn(e);} }

// -------------------- Fun√ß√µes --------------------
function salvarContagemFirebase(){
  if(!codigoSala) return;
  const contagemRef = ref(db,`salas/${codigoSala}/contagem`);
  set(contagemRef,{
    produtos: contagemProdutos,
    ordemAreas,
    valores: valoresManuais
  });
}

function adicionarProduto(){
  const area=document.getElementById("areaInput").value.trim().toUpperCase();
  const codigo=document.getElementById("codigoInput").value.trim().toUpperCase();
  const quantidade=parseInt(document.getElementById("quantidadeInput").value.trim());
  let preco = basePrecos[codigo];

  if(!area) return alert("‚ö†Ô∏è Digite a √°rea.");
  if(!codigo) return alert("‚ö†Ô∏è Digite o c√≥digo.");
  if(!quantidade || quantidade<=0) return alert("‚ö†Ô∏è Quantidade inv√°lida.");

  if(!preco){
    if(!confirm(`C√≥digo "${codigo}" n√£o encontrado. Deseja adicionar manualmente?`)) return;
    const precoManualStr = prompt(`Digite o pre√ßo para "${codigo}":`);
    const precoManual=parseFloat(precoManualStr.replace(',','.'));
    if(isNaN(precoManual)||precoManual<=0){ alert("‚ö†Ô∏è Pre√ßo inv√°lido."); return; }
    basePrecos[codigo]=precoManual;
    preco=precoManual;
  }

  const valor = preco*quantidade;

  contagemProdutos.push({ √°rea:area, c√≥digo:codigo, pares:quantidade, pre√ßo:preco, valor:valor, autor:usuarioId });
  if(!ordemAreas.includes(area)) ordemAreas.push(area);

  renderizarLista();
  document.getElementById("codigoInput").value=""; document.getElementById("quantidadeInput").value=""; document.getElementById("codigoInput").focus();
  atualizarTotaisGerais();
  salvarContagemFirebase();
}

function renderizarLista(){
  const lista=document.getElementById("listaProdutos");
  lista.innerHTML="";
  const agrupado={};

  contagemProdutos.forEach((item,index)=>{
    if(!agrupado[item.√°rea]) agrupado[item.√°rea]=[];
    agrupado[item.√°rea].push({...item,index});
  });

  let html="";
  ordemAreas.forEach(area=>{
    if(!agrupado[area]) return;
    const produtos=agrupado[area];
    let somaPares=0, somaValor=0;

    html+=`<div style="margin-top:30px; padding:8px; background:#f8f9fa; border-left:4px solid #007bff; display:flex; justify-content:space-between; align-items:center;">
      <strong>√Årea:</strong> ${area}
      <div style="display:flex; gap:5px;">
        <button onclick="moverArea('${area}',-1)">‚¨ÜÔ∏è</button>
        <button onclick="moverArea('${area}',1)">‚¨áÔ∏è</button>
      </div>
    </div>`;

    produtos.forEach(prod=>{
      html+=`<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed #ccc;">
        <div><div><strong>${prod.c√≥digo}</strong></div><div>${prod.pares} pares √ó ${formatarValor(prod.pre√ßo)} = <strong>${formatarValor(prod.valor)}</strong></div></div>
        <div style="display:flex; gap:5px;">
        ${prod.autor===usuarioId?`<button onclick="editarProduto(${prod.index})" style="background:#ffc107; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úèÔ∏è Editar</button>
          <button onclick="removerProduto(${prod.index})" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">üóëÔ∏è Remover</button>`:""}
        </div>
      </div>`;
      somaPares+=prod.pares; somaValor+=prod.valor;
    });

    html+=`<div style="padding:6px; text-align:right; font-weight:bold; color:#333;">‚û°Ô∏è Total da √Årea ${area}: ${somaPares} pares | Valor: ${formatarValor(somaValor)}</div>`;
  });

  lista.innerHTML=html;
  renderizarCamposManuais();
}

function editarProduto(index){
  const novoValor=prompt(`Editar quantidade de pares para o c√≥digo ${contagemProdutos[index].c√≥digo}:`,contagemProdutos[index].pares);
  const pares=parseInt(novoValor);
  if(!pares||pares<=0){ alert("‚ö†Ô∏è Quantidade inv√°lida."); return; }
  contagemProdutos[index].pares=pares;
  contagemProdutos[index].valor=contagemProdutos[index].pre√ßo*pares;
  renderizarLista(); atualizarTotaisGerais(); salvarContagemFirebase();
}

function removerProduto(index){
  if(confirm(`Deseja remover o c√≥digo ${contagemProdutos[index].c√≥digo}?`)){
    contagemProdutos.splice(index,1);
    renderizarLista(); atualizarTotaisGerais(); salvarContagemFirebase();
  }
}

function renderizarCamposManuais(){
  const container=document.getElementById("inputsManuais");
  container.innerHTML="";
  camposFixos.forEach(campo=>{
    const div=document.createElement("div");
    div.innerHTML=`<label>${campo}</label>
      <input type="number" data-nome="${campo}" value="${valoresManuais[campo]||''}" oninput="atualizarTotaisGerais()" style="width:100%; padding:5px; border-radius:4px; border:1px solid #ccc;">`;
    container.appendChild(div);
  });
  atualizarTotaisGerais();
}

function atualizarTotaisGerais(){
  let total=contagemProdutos.reduce((s,item)=>s+item.valor,0);
  document.querySelectorAll('#inputsManuais input').forEach(input=>{
    const nome=input.dataset.nome;
    let valor=parseFloat(input.value)||0;
    if(nome.toLowerCase().includes("lucro")) valor=-Math.abs(valor);
    valoresManuais[nome]=valor;
    if(nome!=="Fixo") total+=valor;
  });
  const fixo=valoresManuais["Fixo"]||0;
  const conclusao=total-fixo;
  document.getElementById("valorTotal").textContent=formatarValor(total);
  document.getElementById("valorConclusao").textContent=formatarValor(conclusao);
  salvarContagemFirebase();
}

function formatarValor(num){ return Number.isInteger(num)?num.toString():num.toFixed(2); }

function exportarParaExcel(){
  if(contagemProdutos.length===0){ alert("‚ö†Ô∏è Nenhum item para exportar."); return; }
  const agrupado={};
  contagemProdutos.forEach(item=>{ if(!agrupado[item.√°rea]) agrupado[item.√°rea]=[]; agrupado[item.√°rea].push(item); });
  const dadosFinal=[["√Årea","C√≥digo","Pre√ßo","Pares","Valor"]];
  for(const area in agrupado){ agrupado[area].forEach(item=>dadosFinal.push([item.√°rea,item.c√≥digo,formatarValor(item.pre√ßo),item.pares,formatarValor(item.valor)])); dadosFinal.push([""]); }
  dadosFinal.push([""]); dadosFinal.push([""]);
  let totalProdutos=contagemProdutos.reduce((s,i)=>s+i.valor,0), totalFinal=totalProdutos;
  camposFixos.forEach(campo=>{ if(campo==="Fixo") return; let valor=parseFloat(valoresManuais[campo])||0; if(campo.toLowerCase().includes("lucro")) valor=-Math.abs(valor); totalFinal+=valor; dadosFinal.push(["","","",campo.toUpperCase(),formatarValor(valor)]); });
  dadosFinal.push(["","","","TOTAL",formatarValor(totalFinal)]);
  let fixo=parseFloat(valoresManuais["Fixo"])||0; dadosFinal.push(["","","","FIXO",formatarValor(fixo)]);
  dadosFinal.push(["","","","CONCLUS√ÉO",formatarValor(totalFinal-fixo)]);
  const ws=XLSX.utils.aoa_to_sheet(dadosFinal);
  ws['!cols']=[{wch:12},{wch:12},{wch:10},{wch:15},{wch:12}];
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Contagem");
  XLSX.writeFile(wb,"contagem_ziza.xlsx");
}

function moverArea(area,direcao){
  const index=ordemAreas.indexOf(area); if(index===-1) return;
  const novoIndex=index+direcao; ifconst novoIndex=index+direcao; 
  if(novoIndex<0 || novoIndex>=ordemAreas.length) return;
  [ordemAreas[index], ordemAreas[novoIndex]] = [ordemAreas[novoIndex], ordemAreas[index]];
  renderizarLista();
  salvarContagemFirebase();
}

// Limpar contagem
function limparContagem(){
  if(confirm("Deseja realmente limpar toda a contagem?")){
    contagemProdutos=[]; ordemAreas=[]; valoresManuais={};
    renderizarLista(); atualizarTotaisGerais(); salvarContagemFirebase();
  }
}

// -------------------- Sincroniza√ß√£o Firebase --------------------

// Gerar ID √∫nico para usu√°rio
usuarioId = "user_"+Math.random().toString(36).substr(2,9);

// Solicitar c√≥digo da sala
codigoSala = prompt("Digite o c√≥digo da sala (ex: SALA123):").trim().toUpperCase();
document.getElementById("codigoSalaDisplay").textContent=codigoSala;

// Registrar usu√°rio online
const usuariosRef = ref(db,`salas/${codigoSala}/usuarios/${usuarioId}`);
set(usuariosRef,true);
onDisconnect(usuariosRef).remove();

// Atualizar lista de usu√°rios online
const usuariosSalaRef = ref(db,`salas/${codigoSala}/usuarios`);
onValue(usuariosSalaRef,snap=>{
  const data = snap.val()||{};
  document.getElementById("totalUsuarios").textContent = Object.keys(data).length;
});

// Receber contagem em tempo real
const contagemRef = ref(db,`salas/${codigoSala}/contagem`);
onValue(contagemRef,snap=>{
  const data = snap.val();
  if(!data) return;
  contagemProdutos = data.produtos||[];
  ordemAreas = data.ordemAreas||[];
  valoresManuais = data.valores||{};
  renderizarLista();
  atualizarTotaisGerais();
});

</script>

</body>
</html>